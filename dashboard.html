<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Your Boris Enterprises customer dashboard. Manage vehicles, appointments, and profile.">
  <meta name="robots" content="noindex, nofollow">
  <title>My Dashboard | Boris Enterprises</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/favicon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

  <nav class="navbar">
    <div class="container">
      <a href="index.html" class="nav-logo">
        <img src="assets/logo.png" alt="Boris Enterprises Auto Repair Shop in East Jordan, MI">
      </a>
      <ul class="nav-links">
        <li><a href="https://www.facebook.com/aaronsrepairshop" target="_blank" rel="noopener noreferrer" class="nav-facebook" aria-label="Facebook"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a></li>
        <li><a href="index.html">Home</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="index.html#contact">Contact</a></li>
        <li><a href="tel:2316750723" class="btn btn-primary nav-cta">CALL 231-675-0723</a></li>
        <li><a href="index.html#contact" class="nav-appt-cta">REQUEST APPOINTMENT</a></li>
      </ul>
      <button class="nav-toggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <main>
    <div class="page-hero">
      <h1>MY DASHBOARD</h1>
    </div>

    <!-- Loading State -->
    <div class="dashboard-loading" id="dashboardLoading">
      <div class="container" style="text-align: center; padding: 80px 24px;">
        <p style="font-size: 1.1rem; color: #555;">Loading your dashboard...</p>
      </div>
    </div>

    <!-- Dashboard Content (hidden until auth verified) -->
    <div class="dashboard-content" id="dashboardContent" style="display: none;">

      <!-- Welcome Bar -->
      <section class="dashboard-welcome">
        <div class="container">
          <div class="welcome-bar">
            <div>
              <h2 id="welcomeName">Welcome back!</h2>
              <p id="welcomeEmail" class="welcome-email"></p>
            </div>
            <button class="btn btn-primary" onclick="handleLogout()">LOG OUT</button>
          </div>
        </div>
      </section>

      <!-- Dashboard Grid -->
      <section class="dashboard-grid-section">
        <div class="container">
          <div class="dashboard-grid">

            <!-- My Vehicles -->
            <div class="dashboard-card">
              <div class="dashboard-card-header">
                <h3>My Vehicles</h3>
                <button class="btn-icon" onclick="showAddVehicle()" title="Add Vehicle">+</button>
              </div>
              <div class="dashboard-card-body" id="vehiclesList">
                <p class="empty-state">Loading vehicles...</p>
              </div>

              <!-- Add/Edit Vehicle Form (hidden by default) -->
              <div class="vehicle-form-wrapper" id="vehicleFormWrapper" style="display: none;">
                <h4 id="vehicleFormTitle">Add Vehicle</h4>
                <form id="vehicleForm" onsubmit="submitVehicle(event)">
                  <input type="hidden" id="vehicleId" value="">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="vehicleYear">Year<span class="required-star">*</span></label>
                      <input type="number" id="vehicleYear" required min="1900" max="2027" maxlength="4" placeholder="2003">
                    </div>
                    <div class="form-group">
                      <label for="vehicleMake">Make<span class="required-star">*</span></label>
                      <input type="text" id="vehicleMake" required placeholder="e.g. Dodge">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="vehicleModel">Model<span class="required-star">*</span></label>
                      <input type="text" id="vehicleModel" required placeholder="e.g. Ram 1500">
                    </div>
                    <div class="form-group">
                      <label for="vehiclePlate">License Plate<span class="required-star">*</span></label>
                      <input type="text" id="vehiclePlate" required maxlength="8" style="text-transform: uppercase" placeholder="e.g. ABC1234">
                    </div>
                  </div>
                  <div class="vehicle-form-actions">
                    <button type="submit" class="btn btn-primary" id="vehicleSaveBtn">SAVE VEHICLE</button>
                    <button type="button" class="btn btn-outline" onclick="cancelVehicleForm()">CANCEL</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- My Appointments -->
            <div class="dashboard-card">
              <div class="dashboard-card-header">
                <h3>My Appointments</h3>
              </div>
              <div class="dashboard-card-body" id="appointmentsList">
                <p class="empty-state">Loading appointments...</p>
              </div>
              <div class="dashboard-card-footer">
                <a href="index.html#contact" class="btn btn-primary">REQUEST APPOINTMENT</a>
              </div>
            </div>

            <!-- My Profile -->
            <div class="dashboard-card dashboard-card-full">
              <div class="dashboard-card-header">
                <h3>My Profile</h3>
                <button class="btn-icon" onclick="enableProfileEdit()" id="editProfileBtn" title="Edit Profile">&#9998;</button>
              </div>
              <div class="dashboard-card-body">
                <form id="profileForm" onsubmit="submitProfile(event)">
                  <div class="profile-grid">
                    <div class="form-group">
                      <label for="profileFirstName">First Name</label>
                      <input type="text" id="profileFirstName" disabled autocomplete="given-name">
                    </div>
                    <div class="form-group">
                      <label for="profileLastName">Last Name</label>
                      <input type="text" id="profileLastName" disabled autocomplete="family-name">
                    </div>
                    <div class="form-group">
                      <label for="profilePhone">Phone</label>
                      <input type="tel" id="profilePhone" maxlength="14" placeholder="(231) 675-0723" disabled autocomplete="tel">
                    </div>
                    <div class="form-group">
                      <label for="profileEmail">Email</label>
                      <input type="email" id="profileEmail" disabled autocomplete="email">
                    </div>
                    <div class="form-group profile-checkbox-group">
                      <label class="checkbox-label" for="profileSmsConsent">
                        <input type="checkbox" id="profileSmsConsent" disabled>
                        <span>Opt out of communications (SMS &amp; email)</span>
                      </label>
                    </div>
                  </div>
                  <div class="profile-actions" id="profileActions" style="display: none;">
                    <button type="submit" class="btn btn-primary" id="profileSaveBtn">SAVE CHANGES</button>
                    <button type="button" class="btn btn-outline" onclick="cancelProfileEdit()">CANCEL</button>
                  </div>
                  <div class="profile-message" id="profileMessage"></div>
                </form>
                <div class="reset-password-section" id="resetPasswordSection">
                  <div class="reset-password-divider"></div>
                  <div class="reset-password-row">
                    <div class="reset-password-info">
                      <h4>Password</h4>
                      <p id="resetPasswordDesc">Change your account password via email.</p>
                    </div>
                    <button class="btn btn-primary reset-password-btn" id="resetPasswordBtn" onclick="handleResetPassword()">RESET PASSWORD</button>
                  </div>
                  <div class="reset-password-message" id="resetPasswordMessage"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p class="footer-brand">BORIS ENTERPRISES</p>
      <p class="footer-address">9890 Whitfield Rd, East Jordan, MI 49727</p>
      <p class="footer-phone"><a href="tel:2316750723">231-675-0723</a></p>
      <div class="footer-social">
        <a href="https://www.facebook.com/aaronsrepairshop" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>
      </div>
      <p class="footer-links"><a href="privacy.html">Privacy Policy</a> | <a href="terms.html">Terms of Service</a></p>
      <p class="footer-copy">&copy; 2026 Boris Enterprises. All rights reserved.</p>
    </div>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/main.js"></script>

  <script>
    // --- Dashboard Logic ---
    var currentUserData = null;
    var profileOriginalData = {};

    // --- Phone Formatter ---
    function formatPhone(value) {
      var digits = value.replace(/\D/g, '');
      if (digits.length === 0) return '';
      if (digits.length <= 3) return '(' + digits;
      if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
      return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6, 10);
    }

    // Attach phone formatter to profilePhone input
    document.addEventListener('DOMContentLoaded', function() {
      var phoneInput = document.getElementById('profilePhone');
      if (phoneInput) {
        phoneInput.addEventListener('input', function() {
          var cursorPos = this.selectionStart;
          var oldLen = this.value.length;
          this.value = formatPhone(this.value);
          var newLen = this.value.length;
          var newPos = cursorPos + (newLen - oldLen);
          if (newPos < 0) newPos = 0;
          this.setSelectionRange(newPos, newPos);
        });
      }
    });

    function initDashboard(user) {
      document.getElementById('dashboardLoading').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';

      // Set welcome info
      document.getElementById('welcomeEmail').textContent = user.email;

      // Load user profile from Firestore
      db.collection('users').doc(user.uid).get().then(function(doc) {
        if (doc.exists) {
          currentUserData = doc.data();
          var fullName = currentUserData.name || '';
          document.getElementById('welcomeName').textContent = 'Welcome, ' + (fullName || 'Customer') + '!';

          // Split name into first and last
          var parts = fullName.split(' ');
          var first = parts[0] || '';
          var last = parts.slice(1).join(' ');
          document.getElementById('profileFirstName').value = first;
          document.getElementById('profileLastName').value = last;

          document.getElementById('profilePhone').value = currentUserData.phone ? formatPhone(currentUserData.phone) : '';
          document.getElementById('profileEmail').value = currentUserData.email || user.email;
          document.getElementById('profileSmsConsent').checked = !currentUserData.smsConsent;
        } else {
          document.getElementById('welcomeName').textContent = 'Welcome!';
          document.getElementById('profileEmail').value = user.email;
        }
      }).catch(function(error) {
        console.error('Error loading profile:', error);
        document.getElementById('welcomeName').textContent = 'Welcome!';
        document.getElementById('profileEmail').value = user.email;
      });

      // Setup reset password section (detect Google sign-in)
      setupResetPasswordSection(user);

      // Load vehicles
      loadVehicles(user.uid);

      // Load appointments
      loadAppointments(user.uid);
    }

    // --- Vehicles ---
    function loadVehicles(uid) {
      var container = document.getElementById('vehiclesList');
      db.collection('users').doc(uid).collection('vehicles').get().then(function(snapshot) {
        if (snapshot.empty) {
          container.innerHTML = '<p class="empty-state">No vehicles saved yet. Add your first vehicle above.</p>';
          return;
        }

        var html = '';
        snapshot.forEach(function(doc) {
          var v = doc.data();
          html += '<div class="vehicle-item" data-id="' + doc.id + '">';
          html += '<div class="vehicle-info">';
          html += '<span class="vehicle-title">' + escapeHtml(v.year) + ' ' + escapeHtml(v.make) + ' ' + escapeHtml(v.model) + '</span>';
          html += '<span class="vehicle-plate">Plate: ' + escapeHtml(v.licensePlate) + '</span>';
          html += '</div>';
          html += '<div class="vehicle-actions">';
          html += '<button class="btn-icon btn-edit" onclick="editVehicle(\'' + doc.id + '\', \'' + escapeAttr(v.year) + '\', \'' + escapeAttr(v.make) + '\', \'' + escapeAttr(v.model) + '\', \'' + escapeAttr(v.licensePlate) + '\')" title="Edit">&#9998;</button>';
          html += '<button class="btn-icon btn-delete" onclick="deleteVehicle(\'' + doc.id + '\')" title="Remove">&times;</button>';
          html += '</div>';
          html += '</div>';
        });
        container.innerHTML = html;
      }).catch(function(error) {
        console.error('Error loading vehicles:', error);
        container.innerHTML = '<p class="empty-state">Error loading vehicles. Please try again.</p>';
      });
    }

    function showAddVehicle() {
      document.getElementById('vehicleFormTitle').textContent = 'Add Vehicle';
      document.getElementById('vehicleId').value = '';
      document.getElementById('vehicleYear').value = '';
      document.getElementById('vehicleMake').value = '';
      document.getElementById('vehicleModel').value = '';
      document.getElementById('vehiclePlate').value = '';
      document.getElementById('vehicleSaveBtn').textContent = 'ADD VEHICLE';
      document.getElementById('vehicleFormWrapper').style.display = 'block';
      document.getElementById('vehicleYear').focus();
    }

    function editVehicle(id, year, make, model, plate) {
      document.getElementById('vehicleFormTitle').textContent = 'Edit Vehicle';
      document.getElementById('vehicleId').value = id;
      document.getElementById('vehicleYear').value = year;
      document.getElementById('vehicleMake').value = make;
      document.getElementById('vehicleModel').value = model;
      document.getElementById('vehiclePlate').value = plate;
      document.getElementById('vehicleSaveBtn').textContent = 'SAVE CHANGES';
      document.getElementById('vehicleFormWrapper').style.display = 'block';
      document.getElementById('vehicleYear').focus();
    }

    function cancelVehicleForm() {
      document.getElementById('vehicleFormWrapper').style.display = 'none';
      document.getElementById('vehicleForm').reset();
    }

    function submitVehicle(e) {
      e.preventDefault();
      var user = auth.currentUser;
      if (!user) return;

      var vehicleId = document.getElementById('vehicleId').value;
      var data = {
        year: document.getElementById('vehicleYear').value.trim(),
        make: document.getElementById('vehicleMake').value.trim(),
        model: document.getElementById('vehicleModel').value.trim(),
        licensePlate: document.getElementById('vehiclePlate').value.trim()
      };

      var btn = document.getElementById('vehicleSaveBtn');
      btn.disabled = true;
      btn.textContent = 'SAVING...';

      var vehiclesRef = db.collection('users').doc(user.uid).collection('vehicles');
      var promise;

      if (vehicleId) {
        // Edit existing
        promise = vehiclesRef.doc(vehicleId).update(data);
      } else {
        // Add new
        promise = vehiclesRef.add(data);
      }

      promise.then(function() {
        cancelVehicleForm();
        loadVehicles(user.uid);
      }).catch(function(error) {
        console.error('Error saving vehicle:', error);
        alert('Error saving vehicle. Please try again.');
      }).finally(function() {
        btn.disabled = false;
        btn.textContent = vehicleId ? 'SAVE CHANGES' : 'ADD VEHICLE';
      });
    }

    function deleteVehicle(id) {
      if (!confirm('Are you sure you want to remove this vehicle?')) return;

      var user = auth.currentUser;
      if (!user) return;

      db.collection('users').doc(user.uid).collection('vehicles').doc(id).delete()
        .then(function() {
          loadVehicles(user.uid);
        })
        .catch(function(error) {
          console.error('Error deleting vehicle:', error);
          alert('Error removing vehicle. Please try again.');
        });
    }

    // --- Appointments ---
    // Queries top-level 'appointments' collection filtered by userId
    function loadAppointments(uid) {
      var container = document.getElementById('appointmentsList');
      db.collection('appointments')
        .where('userId', '==', uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(function(snapshot) {
          if (snapshot.empty) {
            container.innerHTML = '<p class="empty-state">No appointments yet. Request one below or from our <a href="index.html#contact">contact page</a>.</p>';
            return;
          }

          var html = '';
          snapshot.forEach(function(doc) {
            var a = doc.data();
            var dateStr = a.preferredDate || a.date || 'N/A';
            var statusClass = 'status-' + (a.status || 'pending');
            var statusLabel = a.status || 'pending';
            var vehicleStr = '';
            if (a.vehicleYear && a.vehicleMake && a.vehicleModel) {
              vehicleStr = a.vehicleYear + ' ' + a.vehicleMake + ' ' + a.vehicleModel;
            }

            html += '<div class="appointment-item">';
            html += '<div class="appointment-info">';
            html += '<span class="appointment-date">' + escapeHtml(dateStr) + '</span>';
            if (vehicleStr) {
              html += '<span class="appointment-vehicle">' + escapeHtml(vehicleStr) + '</span>';
            }
            if (a.message) {
              html += '<span class="appointment-message">' + escapeHtml(a.message) + '</span>';
            }
            if (statusLabel === 'denied') {
              html += '<span class="appointment-denied-note">Your request was not approved. Please call us for more info.</span>';
            }
            html += '</div>';
            html += '<span class="appointment-status ' + statusClass + '">' + escapeHtml(statusLabel) + '</span>';
            html += '</div>';
          });
          container.innerHTML = html;
        })
        .catch(function(error) {
          console.error('Error loading appointments:', error);
          // If the error message contains an index creation link, log it prominently
          if (error.message && error.message.includes('requires an index')) {
            console.error('FIRESTORE INDEX REQUIRED â€” Click the link below to create it:');
            // Extract and log just the URL for easy clicking
            var urlMatch = error.message.match(/https:\/\/\S+/);
            if (urlMatch) {
              console.error(urlMatch[0]);
            }
          }
          container.innerHTML = '<p class="empty-state">Error loading appointments. Please try again.</p>';
        });
    }

    // --- Profile ---
    function enableProfileEdit() {
      document.getElementById('profileFirstName').disabled = false;
      document.getElementById('profileLastName').disabled = false;
      document.getElementById('profilePhone').disabled = false;
      document.getElementById('profileSmsConsent').disabled = false;
      // Email cannot be changed easily through Firestore, keep disabled
      document.getElementById('profileActions').style.display = 'flex';
      document.getElementById('editProfileBtn').style.display = 'none';

      // Save original values for cancel
      profileOriginalData = {
        firstName: document.getElementById('profileFirstName').value,
        lastName: document.getElementById('profileLastName').value,
        phone: document.getElementById('profilePhone').value,
        smsConsent: document.getElementById('profileSmsConsent').checked
      };

      document.getElementById('profileFirstName').focus();
    }

    function cancelProfileEdit() {
      document.getElementById('profileFirstName').value = profileOriginalData.firstName || '';
      document.getElementById('profileLastName').value = profileOriginalData.lastName || '';
      document.getElementById('profilePhone').value = profileOriginalData.phone || '';
      document.getElementById('profileSmsConsent').checked = !!profileOriginalData.smsConsent;
      document.getElementById('profileFirstName').disabled = true;
      document.getElementById('profileLastName').disabled = true;
      document.getElementById('profilePhone').disabled = true;
      document.getElementById('profileSmsConsent').disabled = true;
      document.getElementById('profileActions').style.display = 'none';
      document.getElementById('editProfileBtn').style.display = 'inline-flex';
      hideProfileMessage();
    }

    function submitProfile(e) {
      e.preventDefault();
      var user = auth.currentUser;
      if (!user) return;

      var firstName = document.getElementById('profileFirstName').value.trim();
      var lastName = document.getElementById('profileLastName').value.trim();
      var phone = document.getElementById('profilePhone').value.trim();
      var smsConsent = !document.getElementById('profileSmsConsent').checked;
      var btn = document.getElementById('profileSaveBtn');

      if (!firstName) {
        showProfileMessage('Please enter your first name.', true);
        return;
      }

      var name = firstName + (lastName ? ' ' + lastName : '');

      btn.disabled = true;
      btn.textContent = 'SAVING...';

      // Update Firestore
      db.collection('users').doc(user.uid).update({
        name: name,
        phone: phone,
        smsConsent: smsConsent
      }).then(function() {
        // Update display name
        return user.updateProfile({ displayName: name });
      }).then(function() {
        showProfileMessage('Profile updated successfully!', false);
        document.getElementById('welcomeName').textContent = 'Welcome, ' + name + '!';

        // Disable fields
        document.getElementById('profileFirstName').disabled = true;
        document.getElementById('profileLastName').disabled = true;
        document.getElementById('profilePhone').disabled = true;
        document.getElementById('profileSmsConsent').disabled = true;
        document.getElementById('profileActions').style.display = 'none';
        document.getElementById('editProfileBtn').style.display = 'inline-flex';
      }).catch(function(error) {
        console.error('Error updating profile:', error);
        showProfileMessage('Error updating profile. Please try again.', true);
      }).finally(function() {
        btn.disabled = false;
        btn.textContent = 'SAVE CHANGES';
      });
    }

    function showProfileMessage(text, isError) {
      var msg = document.getElementById('profileMessage');
      msg.textContent = text;
      msg.className = 'profile-message ' + (isError ? 'profile-error' : 'profile-success');
      msg.style.display = 'block';
      setTimeout(function() {
        msg.style.display = 'none';
      }, 4000);
    }

    function hideProfileMessage() {
      document.getElementById('profileMessage').style.display = 'none';
    }

    // --- Reset Password ---
    function setupResetPasswordSection(user) {
      var btn = document.getElementById('resetPasswordBtn');
      var desc = document.getElementById('resetPasswordDesc');
      var section = document.getElementById('resetPasswordSection');
      if (!btn || !section) return;

      // Check if the user signed in with Google (no password to reset)
      var isGoogleUser = false;
      if (user.providerData && user.providerData.length > 0) {
        for (var i = 0; i < user.providerData.length; i++) {
          if (user.providerData[i].providerId === 'google.com') {
            isGoogleUser = true;
            break;
          }
        }
      }

      // Check if the user also has a password provider
      var hasPasswordProvider = false;
      if (user.providerData && user.providerData.length > 0) {
        for (var j = 0; j < user.providerData.length; j++) {
          if (user.providerData[j].providerId === 'password') {
            hasPasswordProvider = true;
            break;
          }
        }
      }

      if (isGoogleUser && !hasPasswordProvider) {
        btn.style.display = 'none';
        desc.textContent = 'You signed in with Google \u2014 no password to reset.';
        desc.className = 'reset-password-google-note';
      }
    }

    function handleResetPassword() {
      var user = auth.currentUser;
      if (!user || !user.email) return;

      var btn = document.getElementById('resetPasswordBtn');
      var msg = document.getElementById('resetPasswordMessage');

      btn.disabled = true;
      btn.textContent = 'SENDING...';

      firebase.auth().sendPasswordResetEmail(user.email)
        .then(function() {
          msg.textContent = 'Password reset email sent! Check your inbox.';
          msg.className = 'reset-password-message reset-password-success';
          msg.style.display = 'block';
          btn.textContent = 'EMAIL SENT';
          setTimeout(function() {
            msg.style.display = 'none';
            btn.disabled = false;
            btn.textContent = 'RESET PASSWORD';
          }, 5000);
        })
        .catch(function(error) {
          console.error('Error sending password reset email:', error);
          msg.textContent = 'Failed to send reset email. Please try again.';
          msg.className = 'reset-password-message reset-password-error';
          msg.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'RESET PASSWORD';
          setTimeout(function() {
            msg.style.display = 'none';
          }, 5000);
        });
    }

    // --- Utility ---
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(text));
      return div.innerHTML;
    }

    function escapeAttr(text) {
      if (!text) return '';
      return String(text).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\/g, '\\\\');
    }
  </script>

</body>
</html>
